{% extends '../CommonAdmin/EditAction/EditBuilderAction.php.twig' %}

{% block orm_use %}
use Doctrine\DBAL\LockMode;
use Doctrine\ORM\ORMException;
{% endblock %}

{% block getObject -%}
    protected function getObject($pk)
    {
        return $this->getDoctrine()
                    ->getManager({{ entity_manager|default('')|wrap('"') }})
                    ->getRepository('{{ model }}')
                    ->find($pk);
    }
{% endblock %}

{% block saveObject -%}
    protected function saveObject(\{{ model }} ${{ builder.ModelClass }})
    {
        $em = $this->getDoctrine()->getManager({{ entity_manager|default('')|wrap('"') }});
        $em->persist(${{ builder.ModelClass }});
        $em->flush();
    }
{% endblock %}

{% block getVersions %}
    protected function getVersions()
    {
        return $this->get('session')->get('{{ namespace_prefix }}\{{ bundle_name }}\{{ builder.BaseGeneratorName }}Edit\Versions', array());
    }
{% endblock %}

{% block setVersions %}
    protected function setVersions($versions = array())
    {
        $this->get('session')->set('{{ namespace_prefix }}\{{ bundle_name }}\{{ builder.BaseGeneratorName }}Edit\Versions', $versions);
    }
{% endblock %}


{% block saveVersion %}
    protected function saveVersion($pk, $version)
    {
        $versions = $this->getVersions();
        $versions[$pk] = $version;
        $this->setVersions($versions);
    }
{% endblock %}

{% block checkObjectLock -%}
{% if lock_mode is not null -%}
    $versions = $this->get('session')->get('{{ namespace_prefix }}\{{ bundle_name }}\{{ builder.BaseGeneratorName }}Edit\Versions', array());
    $this->getDoctrine()->getManager({{ entity_manager|default('')|wrap('"') }})->lock($object, {{ lock_mode|default('LockMode::NONE') }}, $versions[$pk]);
{%- endif %}
{% endblock %}

{% block lockException %}ORMException{% endblock %}