{% extends '../CommonAdmin/EditAction/EditBuilderAction.php.twig' %}

{% block orm_use %}
use Doctrine\ODM\MongoDB\LockMode;
use Doctrine\ODM\MongoDB\LockException;
{% endblock %}

{% block getObject -%}
    protected function getObject($pk)
    {
        $pk = is_numeric($pk) ? intval($pk) : $pk;

        return $this->getDocumentManager()
                    ->getRepository('{{ model }}')
                    ->find($pk);
    }
{% endblock %}

{% block saveObject -%}
    protected function saveObject(\{{ model }} ${{ builder.ModelClass }})
    {
        $dm = $this->getDocumentManager();
        $dm->persist(${{ builder.ModelClass }});
        $dm->flush();
    }
{% endblock %}

{% block checkObjectLock -%}
{% if concurrency_lock -%}
    $versions = $this->getVersions();
    $this->getDocumentManager()->lock($object, 'LockMode::OPTIMISTIC', $versions[$pk]);
{%- endif %}
{% endblock %}

{% block lockException %}LockException{% endblock %}